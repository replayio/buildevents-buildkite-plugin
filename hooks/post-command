#!/bin/bash -eu

if [ -n "$BUILDKITE_TRIGGERED_FROM_BUILD_ID" ]; then
  TRACE_ID=$BUILDKITE_TRIGGERED_FROM_BUILD_ID
else
  TRACE_ID=$BUILDKITE_BUILD_ID
fi

if [ -n "$BUILDKITE_STEP_KEY" ]; then
  SPAN_NAME=$BUILDKITE_STEP_KEY
elif [ -n "$BUILDKITE_LABEL" ]; then
  SPAN_NAME=$BUILDKITE_LABEL
elif [ -n "$BUILDKITE_COMMAND" ]; then
  SPAN_NAME=$BUILDKITE_COMMAND
else
  SPAN_NAME=$BUILDKITE_STEP_ID
fi

buildevents step $TRACE_ID $BUILDKITE_STEP_ID $_BUILDEVENT_STEP_START_TIME $SPAN_NAME
